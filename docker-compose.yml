#
# DOCKER COMPOSE FOR FLOWKIT
#

version: '3.7'

networks:
  db:
  redis:
  zero:



services:

  flowdb:
    container_name: flowdb
    image: flowminder/flowdb:latest
    build:
      context: ./flowdb/
      dockerfile: Dockerfile
    ports:
      - ${FLOWDB_PORT:?Must set FLOWDB_PORT env var}:5432

    environment: &base-flowdb-environment
      POSTGRES_DB: ${POSTGRES_DB:?Must set POSTGRES_DB env var}
      POSTGRES_USER: ${POSTGRES_USER:?Must set POSTGRES_USER env var}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?Must set POSTGRES_PASSWORD env var}
      FLOWMACHINE_FLOWDB_USER: ${FLOWMACHINE_FLOWDB_USER:?Must set FLOWMACHINE_FLOWDB_USER env var}
      FLOWMACHINE_FLOWDB_PASS: ${FLOWMACHINE_FLOWDB_PASS:?Must set FLOWMACHINE_FLOWDB_PASS env var}
      FLOWAPI_FLOWDB_USER: ${FLOWAPI_FLOWDB_USER:?Must set FLOWAPI_FLOWDB_USER env var}
      FLOWAPI_FLOWDB_PASS: ${FLOWAPI_FLOWDB_PASS:?Must set FLOWAPI_FLOWDB_PASS env var}
      CACHE_SIZE: ${CACHE_SIZE:-""}
      CACHE_HALF_LIFE: ${CACHE_HALF_LIFE:?Must set CACHE_HALF_LIFE env var}
      FLOWDB_DEBUG: ${FLOWDB_DEBUG:?Must set FLOWDB_DEBUG env var}
    shm_size: 1G
    tty: true
    stdin_open: true
    restart: always
    networks:
      db:
        aliases:
          - flowdb

  flowdb_testdata:
    container_name: flowdb_testdata
    image: flowminder/flowdb-testdata:latest
    build:
      context: ./flowdb/testdata/
      dockerfile: Dockerfile
    ports:
      - ${FLOWDB_PORT:?Must set FLOWDB_PORT env var}:5432
    environment:
      *base-flowdb-environment
    shm_size: 1G
    tty: true
    stdin_open: true
    restart: always
    networks:
      db:
        aliases:
          - flowdb

  flowdb_synthetic_data:
    container_name: flowdb_synthetic_data
    image: flowminder/flowdb-synthetic-data:latest
    build:
      context: ./flowdb/testdata/
      dockerfile: Dockerfile.synthetic_data
    ports:
      - ${FLOWDB_PORT:?Must set FLOWDB_PORT env var}:5432
    environment:
      << : *base-flowdb-environment
      SYNTHETIC_DATA_GENERATOR: ${SYNTHETIC_DATA_GENERATOR:?Must set SYNTHETIC_DATA_GENERATOR env var}
      N_SITES: ${N_SITES:?Must set N_SITES env var}
      N_CELLS: ${N_CELLS:?Must set N_CELLS env var}
      N_SUBSCRIBERS: ${N_SUBSCRIBERS:?Must set N_SUBSCRIBERS env var}
      N_DAYS: ${N_DAYS:?Must set N_DAYS env var}
      N_CALLS: ${N_CALLS:?Must set N_CALLS env var}
      N_SMS: ${N_SMS:?Must set N_SMS env var}
      N_MDS: ${N_MDS:?Must set N_MDS env var}
      N_TACS: ${N_TACS:?Must set N_TACS env var}
      P_OUT_OF_AREA: ${P_OUT_OF_AREA:?Must set P_OUT_OF_AREA env var}
      P_RELOCATE: ${P_RELOCATE:?Must set P_RELOCATE env var}
      INTERACTIONS_MULTIPLIER: ${INTERACTIONS_MULTIPLIER:?Must set INTERACTIONS_MULTIPLIER env var}
      DISASTER_START: ${DISASTER_START:?Must set DISASTER_START env var}
      DISASTER_END: ${DISASTER_END:?Must set DISASTER_END env var}
    shm_size: 1G
    tty: true
    stdin_open: true
    restart: always
    networks:
      db:
        aliases:
          - flowdb

  flowmachine:
    container_name: flowmachine
    image: flowminder/flowmachine:latest
    build:
      context: ./flowmachine
      dockerfile: Dockerfile
    ports:
      - ${FLOWMACHINE_PORT:?Must set FLOWMACHINE_PORT env var}:5555
    depends_on:
      - query_locker
    tty: true
    stdin_open: true
    environment:
      - FLOWMACHINE_LOG_LEVEL=${FLOWMACHINE_LOG_LEVEL:?Must set FLOWMACHINE_LOG_LEVEL env var}
      - FLOWMACHINE_SERVER_DEBUG_MODE=${FLOWMACHINE_SERVER_DEBUG_MODE:?Must set FLOWMACHINE_SERVER_DEBUG_MODE env var}
      - FLOWDB_PORT=5432
      - FLOWDB_HOST=${FLOWDB_HOST:?Must set FLOWDB_HOST env var}
      - FLOWMACHINE_FLOWDB_USER=${FLOWMACHINE_FLOWDB_USER:?Must set FLOWMACHINE_FLOWDB_USER env var}
      - FLOWMACHINE_FLOWDB_PASS=${FLOWMACHINE_FLOWDB_PASS:?Must set FLOWMACHINE_FLOWDB_PASS env var}
      - REDIS_HOST=query_locker
      - REDIS_PORT=6379
      - REDIS_PASS=${REDIS_PASS:?Must set REDIS_PASS env var}
    restart: always
    networks:
      - zero
      - db
      - redis

  flowapi:
    container_name: flowapi
    image: flowminder/flowapi:latest
    build:
      context: ./flowapi
      dockerfile: Dockerfile
    ports:
      - ${FLOWAPI_PORT:?Must set FLOWAPI_PORT env var}:9090
    environment:
      - FLOWMACHINE_HOST=flowmachine
      - FLOWAPI_FLOWDB_USER=${FLOWAPI_FLOWDB_USER:?Must set FLOWAPI_FLOWDB_USER env var}
      - FLOWAPI_FLOWDB_PASS=${FLOWAPI_FLOWDB_PASS:?Must set FLOWAPI_FLOWDB_PASS env var}
      - FLOWDB_HOST=${FLOWDB_HOST:?Must set FLOWDB_HOST env var}
      - FLOWDB_PORT=5432
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:?Must set JWT_SECRET_KEY env var}
      - FLOWAPI_LOG_LEVEL=${FLOWAPI_LOG_LEVEL:?Must set FLOWAPI_LOG_LEVEL env var}
    tty: true
    stdin_open: true
    restart: always
    networks:
      - db
      - zero

  flowauth:
    container_name: flowauth
    image: flowminder/flowauth:latest
    build:
      context: ./flowauth
      dockerfile: Dockerfile
    ports:
      - ${FLOWAUTH_PORT:?Must set FLOWAUTH_PORT env var}:80
    environment:
      DEMO_MODE: ${DEMO_MODE:?Must set DEMO_MODE env var}

  query_locker:
    container_name: redis_flowkit
    image: bitnami/redis
    ports:
      - ${REDIS_PORT:?Must set REDIS_PORT env var}:6379
    environment:
      - REDIS_PASS=${REDIS_PASS:?Must set REDIS_PASS env var}
    restart: always
    networks:
      redis:
        aliases:
          - redis
