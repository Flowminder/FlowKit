# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at http://mozilla.org/MPL/2.0/.

- name: "Create user '{{ USERNAME }}'"
  become: yes
  user:
    name: "{{ USERNAME }}"
    state: present
    groups: docker, wheel
    password: "{{ PASSWORD }}"

- name: "Check that file {{ AUTHORIZED_KEYS_FILE }} exists"
  local_action: stat path="{{ playbook_dir }}/{{ AUTHORIZED_KEYS_FILE }}"
  register: p
- debug:
    msg: "Please add public ssh keys to the file: {{ playbook_dir }}/{{ AUTHORIZED_KEYS_FILE }}"
  when: not p.stat.exists
  failed_when: not p.stat.exists

- name: "Enable ssh access for users defined above"
  authorized_key:
    user: "{{ item }}"
    state: present
    key: "{{ lookup('file', playbook_dir + '/' + AUTHORIZED_KEYS_FILE) }}"
  with_items:
    - "{{ USERNAME }}"
